<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç MDB –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .field-list { max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Cable.mdb</h1>
    
    <div class="test-card">
        <h2>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö</h2>
        <button onclick="testMetadata()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ</button>
        <div id="metadata-result"></div>
    </div>

    <div class="test-card">
        <h2>2. –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü</h2>
        <button onclick="testTableLoading()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Ç–∞–±–ª–∏—Ü</button>
        <div id="table-result"></div>
    </div>

    <div class="test-card">
        <h2>3. –°–∏–º—É–ª—è—Ü–∏—è useFileManager.loadMdbData()</h2>
        <button onclick="testMdbDataFunction()">–°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é</button>
        <div id="function-result"></div>
    </div>

    <script>
        async function testMetadata() {
            const resultDiv = document.getElementById('metadata-result');
            resultDiv.innerHTML = '<div class="status info">–ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ...</div>';
            
            try {
                const response = await fetch('/data/exported/metadata.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const metadata = await response.json();
                
                resultDiv.innerHTML = `
                    <div class="status success">‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!</div>
                    <p><strong>–í—Å–µ–≥–æ —Ç–∞–±–ª–∏—Ü –≤ –ë–î:</strong> ${metadata.total_tables_in_db}</p>
                    <p><strong>–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ —Ç–∞–±–ª–∏—Ü:</strong> ${Object.keys(metadata.exported_tables).length}</p>
                    <p><strong>–î–∞—Ç–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:</strong> ${metadata.export_date}</p>
                    <details>
                        <summary>–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü (–∫–ª–∏–∫)</summary>
                        <div class="field-list">
                            ${Object.entries(metadata.exported_tables).map(([name, count]) => 
                                `<div>${name} - ${count} –∑–∞–ø–∏—Å–µ–π</div>`
                            ).join('')}
                        </div>
                    </details>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }

        async function testTableLoading() {
            const resultDiv = document.getElementById('table-result');
            resultDiv.innerHTML = '<div class="status info">–¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–∞–±–ª–∏—Ü...</div>';
            
            const tablesToTest = ['–°–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫', '01 –†–µ–º–æ–Ω—Ç—ã –∫–∞–± –ª–∏–Ω–∏–∏', '–ó–∞–≤–æ–¥—ã'];
            const results = [];
            
            for (const tableName of tablesToTest) {
                try {
                    const fileName = tableName
                        .replace(/\s+/g, '_')
                        .replace(/\//g, '_')
                        .replace(/‚Ññ/g, 'num')
                        .replace(/"/g, '"')
                        .replace(/\?/g, '_')
                        .replace(/:/g, '_')
                        .replace(/\*/g, '_')
                        .replace(/</g, '_')
                        .replace(/>/g, '_')
                        .replace(/\|/g, '_');

                    const response = await fetch(`/data/exported/${fileName}.json`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    const tableData = await response.json();
                    
                    if (tableData.data && tableData.data.length > 0) {
                        const fields = Object.keys(tableData.data[0]);
                        results.push({
                            name: tableName,
                            status: 'success',
                            rows: tableData.total_rows,
                            fields: fields.length,
                            sampleFields: fields.slice(0, 3)
                        });
                    } else {
                        results.push({name: tableName, status: 'empty'});
                    }
                } catch (error) {
                    results.push({name: tableName, status: 'error', error: error.message});
                }
            }
            
            resultDiv.innerHTML = `
                <div class="status success">‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ</div>
                ${results.map(result => {
                    if (result.status === 'success') {
                        return `
                            <div class="status success">
                                <strong>${result.name}</strong>: ${result.rows} –∑–∞–ø–∏—Å–µ–π, ${result.fields} –ø–æ–ª–µ–π
                                <br>–ü—Ä–∏–º–µ—Ä—ã –ø–æ–ª–µ–π: ${result.sampleFields.join(', ')}
                            </div>
                        `;
                    } else if (result.status === 'empty') {
                        return `<div class="status error"><strong>${result.name}</strong>: –ü—É—Å—Ç–∞—è —Ç–∞–±–ª–∏—Ü–∞</div>`;
                    } else {
                        return `<div class="status error"><strong>${result.name}</strong>: –û—à–∏–±–∫–∞ - ${result.error}</div>`;
                    }
                }).join('')}
            `;
        }

        async function testMdbDataFunction() {
            const resultDiv = document.getElementById('function-result');
            resultDiv.innerHTML = '<div class="status info">–°–∏–º—É–ª–∏—Ä—É–µ–º —Ä–∞–±–æ—Ç—É useFileManager.loadMdbData()...</div>';
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
                const metadataResponse = await fetch('/data/exported/metadata.json');
                if (!metadataResponse.ok) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö');
                }
                const metadata = await metadataResponse.json();

                const fileId = 'mdb_' + Date.now();
                const alias = 'CableMDB';
                const sheets = {};
                let totalFields = 0;
                let loadedTables = 0;

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 5 —Ç–∞–±–ª–∏—Ü –¥–ª—è —Ç–µ—Å—Ç–∞
                const tablesToLoad = Object.entries(metadata.exported_tables).slice(0, 5);
                
                for (const [tableName, rowCount] of tablesToLoad) {
                    try {
                        const fileName = tableName
                            .replace(/\s+/g, '_')
                            .replace(/\//g, '_')
                            .replace(/‚Ññ/g, 'num')
                            .replace(/"/g, '"')
                            .replace(/\?/g, '_')
                            .replace(/:/g, '_')
                            .replace(/\*/g, '_')
                            .replace(/</g, '_')
                            .replace(/>/g, '_')
                            .replace(/\|/g, '_');

                        const tableResponse = await fetch(`/data/exported/${fileName}.json`);
                        if (!tableResponse.ok) {
                            console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É ${tableName}`);
                            continue;
                        }
                        
                        const tableData = await tableResponse.json();
                        
                        if (tableData.data && tableData.data.length > 0) {
                            const fields = Object.keys(tableData.data[0]);
                            const descriptions = {};
                            
                            // –°–æ–∑–¥–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏—è –ø–æ–ª–µ–π —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
                            fields.forEach(field => {
                                const sampleValue = tableData.data[0][field];
                                if (sampleValue && sampleValue.toString().trim()) {
                                    const trimmedSample = sampleValue.toString().length > 40 ? 
                                        sampleValue.toString().substring(0, 37) + '...' : sampleValue.toString();
                                    descriptions[field] = `–ü—Ä–∏–º–µ—Ä: ${trimmedSample}`;
                                } else {
                                    descriptions[field] = field;
                                }
                            });

                            const sheetAlias = `${alias}_${tableName.replace(/[^–∞-—è–ê-–Øa-zA-Z0-9]/g, '_')}`;
                            
                            sheets[tableName] = {
                                name: tableName,
                                alias: sheetAlias,
                                fields: fields,
                                descriptions: descriptions,
                                fieldsCount: fields.length,
                                selected: true,
                                originalIndex: Object.keys(sheets).length,
                                rowCount: rowCount,
                                isMdbTable: true
                            };
                            
                            totalFields += fields.length;
                            loadedTables++;
                        }
                    } catch (error) {
                        console.warn(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã ${tableName}:`, error);
                    }
                }

                const newFile = {
                    id: fileId,
                    name: 'Cable.mdb',
                    alias: alias,
                    sheets: sheets,
                    totalFields: totalFields,
                    hasMultipleSheets: true,
                    isMdbFile: true,
                    sourceFile: metadata.source_file,
                    exportDate: metadata.export_date
                };

                resultDiv.innerHTML = `
                    <div class="status success">‚úÖ –°–∏–º—É–ª—è—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!</div>
                    <p><strong>–§–∞–π–ª ID:</strong> ${newFile.id}</p>
                    <p><strong>–ê–ª–∏–∞—Å:</strong> ${newFile.alias}</p>
                    <p><strong>–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–∞–±–ª–∏—Ü:</strong> ${loadedTables}</p>
                    <p><strong>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª–µ–π:</strong> ${totalFields}</p>
                    <p><strong>–ú–Ω–æ–≥–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π:</strong> ${newFile.hasMultipleSheets ? '–î–∞' : '–ù–µ—Ç'}</p>
                    <p><strong>MDB —Ñ–∞–π–ª:</strong> ${newFile.isMdbFile ? '–î–∞' : '–ù–µ—Ç'}</p>
                    <details>
                        <summary>–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É loadedFiles (–∫–ª–∏–∫)</summary>
                        <pre>${JSON.stringify(newFile, null, 2)}</pre>
                    </details>
                `;

            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞ —Å–∏–º—É–ª—è—Ü–∏–∏: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html> 
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ MDB</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        input[type="file"] {
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }
        .file-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        .table-list {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .table-item {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .table-name {
            font-weight: bold;
            color: #495057;
        }
        .table-details {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 4px;
        }
        .field-list {
            display: inline-block;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            margin: 2px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ MDB —Ñ–∞–π–ª–æ–≤</h1>
    
    <div class="test-card">
        <h2>1. –í—ã–±–µ—Ä–∏—Ç–µ MDB –∏–ª–∏ ACCDB —Ñ–∞–π–ª</h2>
        <input type="file" id="mdbFileInput" accept=".mdb,.accdb" />
        <p style="color: #666; font-size: 0.9rem;">
            –í—ã–±–µ—Ä–∏—Ç–µ –ª—é–±–æ–π —Ñ–∞–π–ª Microsoft Access (.mdb –∏–ª–∏ .accdb) –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        </p>
        <button onclick="loadSelectedFile()">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
        <div id="load-result"></div>
    </div>

    <div class="test-card">
        <h2>2. –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏</h2>
        <div id="file-info" style="display: none;">
            <div class="file-info">
                <h3 id="file-name"></h3>
                <div id="file-stats"></div>
            </div>
            <div id="tables-list"></div>
        </div>
    </div>

    <div class="test-card">
        <h2>3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è useFileManager</h2>
        <div id="structure-info" style="display: none;">
            <p>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –ø–µ—Ä–µ–¥–∞–Ω–∞ –≤ useFileManager:</p>
            <details>
                <summary style="cursor: pointer; color: #007bff;">–ü–æ–∫–∞–∑–∞—Ç—å JSON —Å—Ç—Ä—É–∫—Ç—É—Ä—É (–∫–ª–∏–∫)</summary>
                <pre id="json-structure" style="background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; white-space: pre-wrap;"></pre>
            </details>
        </div>
    </div>

    <script type="module">
        import MDBReader from './node_modules/mdb-reader/dist/mdb-reader.js';
        import { Buffer } from './node_modules/buffer/index.js';
        
        // –ü–æ–ª–∏—Ñ–∏–ª–ª –¥–ª—è Buffer –≤ –±—Ä–∞—É–∑–µ—Ä–µ
        window.Buffer = Buffer;
        
        let currentFileData = null;

        window.loadSelectedFile = async function() {
            const fileInput = document.getElementById('mdbFileInput');
            const resultDiv = document.getElementById('load-result');
            const fileInfoDiv = document.getElementById('file-info');
            const structureInfoDiv = document.getElementById('structure-info');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                resultDiv.innerHTML = '<div class="status error">‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</div>';
                return;
            }
            
            const file = fileInput.files[0];
            resultDiv.innerHTML = '<div class="status info">‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–∞–π–ª...</div>';
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const buffer = Buffer.from(arrayBuffer);
                const reader = new MDBReader(buffer);
                
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã
                const tableNames = reader.getTableNames();
                
                // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞–∫ –≤ useFileManager
                const fileId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const alias = file.name.replace(/\.[^/.]+$/, "").replace(/[^–∞-—è–ê-–Øa-zA-Z0-9]/g, '_');
                
                const sheets = {};
                let totalFields = 0;
                const tablesInfo = [];
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é —Ç–∞–±–ª–∏—Ü—É
                for (const tableName of tableNames) {
                    try {
                        const table = reader.getTable(tableName);
                        const columnNames = table.getColumnNames();
                        const rowCount = table.rowCount;
                        
                        // –ü–æ–ª—É—á–∞–µ–º –æ–±—Ä–∞–∑–µ—Ü –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏–π
                        let descriptions = {};
                        if (rowCount > 0) {
                            const sampleData = table.getData({ rowLimit: 1 });
                            if (sampleData.length > 0) {
                                columnNames.forEach(columnName => {
                                    const sampleValue = sampleData[0][columnName];
                                    if (sampleValue !== null && sampleValue !== undefined) {
                                        const trimmedSample = String(sampleValue).length > 40 ? 
                                            String(sampleValue).substring(0, 37) + '...' : String(sampleValue);
                                        descriptions[columnName] = `–ü—Ä–∏–º–µ—Ä: ${trimmedSample}`;
                                    } else {
                                        descriptions[columnName] = columnName;
                                    }
                                });
                            }
                        } else {
                            columnNames.forEach(columnName => {
                                descriptions[columnName] = columnName;
                            });
                        }
                        
                        const sheetAlias = tableNames.length > 1 ? 
                            `${alias}_${tableName.replace(/[^–∞-—è–ê-–Øa-zA-Z0-9]/g, '_')}` : alias;
                        
                        sheets[tableName] = {
                            name: tableName,
                            alias: sheetAlias,
                            fields: columnNames,
                            descriptions: descriptions,
                            fieldsCount: columnNames.length,
                            selected: true,
                            originalIndex: Object.keys(sheets).length,
                            rowCount: rowCount,
                            isMdbTable: true
                        };
                        
                        totalFields += columnNames.length;
                        
                        tablesInfo.push({
                            name: tableName,
                            fields: columnNames,
                            rowCount: rowCount,
                            descriptions: descriptions
                        });
                        
                    } catch (tableError) {
                        console.warn(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–∞–±–ª–∏—Ü—ã ${tableName}:`, tableError);
                        tablesInfo.push({
                            name: tableName,
                            error: tableError.message
                        });
                    }
                }
                
                // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–∞
                currentFileData = {
                    id: fileId,
                    name: file.name,
                    alias: alias,
                    sheets: sheets,
                    totalFields: totalFields,
                    hasMultipleSheets: tableNames.length > 1,
                    isMdbFile: true
                };
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                resultDiv.innerHTML = '<div class="status success">‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!</div>';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
                document.getElementById('file-name').textContent = file.name;
                document.getElementById('file-stats').innerHTML = `
                    <strong>–¢–∞–±–ª–∏—Ü:</strong> ${tableNames.length}<br>
                    <strong>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª–µ–π:</strong> ${totalFields}<br>
                    <strong>–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                    <strong>–ê–ª–∏–∞—Å:</strong> ${alias}
                `;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü
                const tablesListDiv = document.getElementById('tables-list');
                const tablesHtml = tablesInfo.map(tableInfo => {
                    if (tableInfo.error) {
                        return `
                            <div class="table-item">
                                <div class="table-name" style="color: #dc3545;">‚ùå ${tableInfo.name}</div>
                                <div class="table-details">–û—à–∏–±–∫–∞: ${tableInfo.error}</div>
                            </div>
                        `;
                    } else {
                        const fieldsPreview = tableInfo.fields.slice(0, 5).map(field => 
                            `<span class="field-list">${field}</span>`
                        ).join('');
                        const moreFields = tableInfo.fields.length > 5 ? 
                            `<span style="color: #6c757d;">...–µ—â–µ ${tableInfo.fields.length - 5}</span>` : '';
                        
                        return `
                            <div class="table-item">
                                <div class="table-name">üóÑÔ∏è ${tableInfo.name}</div>
                                <div class="table-details">
                                    <strong>–ó–∞–ø–∏—Å–µ–π:</strong> ${tableInfo.rowCount} | 
                                    <strong>–ü–æ–ª–µ–π:</strong> ${tableInfo.fields.length}
                                    <br>
                                    <div style="margin-top: 6px;">
                                        ${fieldsPreview} ${moreFields}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }).join('');
                
                tablesListDiv.innerHTML = `
                    <h4>–¢–∞–±–ª–∏—Ü—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:</h4>
                    <div class="table-list">${tablesHtml}</div>
                `;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º JSON —Å—Ç—Ä—É–∫—Ç—É—Ä—É
                document.getElementById('json-structure').textContent = JSON.stringify(currentFileData, null, 2);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
                fileInfoDiv.style.display = 'block';
                structureInfoDiv.style.display = 'block';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                resultDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞: ${error.message}</div>`;
                fileInfoDiv.style.display = 'none';
                structureInfoDiv.style.display = 'none';
            }
        };
    </script>
</body>
</html> 